### 命令行用法

```bash
./setup.sh [--ui] [--help][-h] [--auto][-a]{...}
```

`--ui` 启动基于`Dialog`的控制台UI

`--help` `-h` 显示帮助信息

`--auto` `-a` 启动自动（无人值守）安装



 ```bash
./setup.sh [--cui][-U] [--auto][-A] [-m(0/1)] [--disk (/dev/block)] [--fs (ext4/btrfs)] [--kernel linux(-kernel)] [--boot (bootmgr)] [--de (desktop manager)] [--edu] [--cn]
 ```

以下参数只有在启用了`--auto`参数才会被读取

`-m` 设置安装模式，可选选项有0和1,分别对应最小化安装和标准安装。默认为1。

​	`最小化安装` 仅提供一个命令行界面，不安装X服务和任何其他图形化组件。安装一些服务器必备的软件（如vim，ssh等）

​	`标准安装` 默认搭配KDE桌面的Archlinux系统

`--disk` 选择安装Archlinux系统的分区，使用此选项必须预先创建好分区。如果没有此选项，脚本会清除整个第一硬盘（`/dev/sda`或`/dev/nvmen1`）。

`--fs` 选择系统分区的文件系统，可选Ext4和Btrfs。默认为Ext4。

`--kernel` 选择系统的内核，可选列表如下。默认为`linux`内核。如果想使用其他非主流内核请结束安装向导后自行更换。

​	`linux` 包含了对应的 Linux 内核和内核模块，官方原版内核再加几个补丁。

​	`linux-zen` 一些内核黑客合作的结果，提供了适合日常使用的优秀内核。

​	`linux-lts` 长期支持版，包含了长期支持的Linux内核和内核模块。

​	`linux-hardened` 更加注重安全的Linux内核，采用一系列加固补丁以减少内核和用户空间产生漏洞的风险。和linux相比，还启用了一些加固选项，比如用户命名空间(同时通过补丁禁用未授权用户的访问)、审计以及SELinux。

`--boot` 选择引导器，可选GRUB。默认为GRUB。后期会加入针对其他引导器的支持。

`--de` 选择要使用的桌面环境，可选KDE和no。默认为KDE。后期会加入针对其他桌面环境的支持。

`--edu` 为按流量计费的教育网用户设计，会修改镜像源为教育网镜像（教育网或ipv6镜像可免流），优先使用清华源（非教育网用户也能使用）。如果需要使用中文需额外添加`--cn`参数，教育网软件源会保留。

`--cn` 表示为中文用户，将会生成中文的locale,并修改镜像源为国内公网镜像，优先使用阿里公共镜像源（教育网用户使用有可能会会计入流量）。如果额外添加了`--edu`参数，会设置镜像源为教育网源。



### 操作逻辑

##### 自动安装

1. 检查网络
2. 检查EFI分区，并自动选择，如果没有则调用创建EFI分区
3. 分区
4. 挂载分区
5. 自动修改源
6. 检测驱动（确定需要安装的驱动包）
7. 安装包
8. 复制二次安装脚本
9. `genfstab`
10. `arch-chroot`自动执行二次安装脚本，使用服务器配置方案`最小化安装`或标准配置方案`标准安装`



##### 自定义安装

1. 检查网络，检测驱动
2. 检查EFI分区，并自动选择，如果没有则调用创建EFI分区
3. 检查是否存在Linux文件系统，如果没有提示分区，如果有提示是否使用
4. 提示选择地区和使用的软件源
5. 挂载分区
6. 安装包
7. 复制二次安装脚本
8. `genfstab`
9. `arch-chroot`执行二次安装脚本



##### 二次安装脚本

1. 按照一次安装的配置修改镜像源
2. 设置时区，UTC时间
3. 按照一次安装的配置设置语言
4. 设置`locale.conf`
5. 设置`hostname`,`hosts`
6. 提示创建新用户并修改密码
7. 安装服务器配置包含的包
8. `visudo`
9. 如果安装了桌面环境，安装字体
10. 安装GRUB引导
11. 提示需要安装的软件包
12. 如果安装了KDE,启动`sddm`和`NetworkManager`服务



### TO-DO

- [x] 网络状态检查
- [ ] 修改源函数
- [ ] 自动分区创建分区脚本
- [ ] 手动创建分区
- [ ] 



### TIPS

###### 读取未分区空间

可用于自动创建新分区

```bash
x=$(echo 'F
' | fdisk /dev/nvme0n1 | grep 'Un' | awk -F': ' '{print $3}' | awk -F', ' '{print $1}' | awk -F' ' '{print $1}')

y=$(echo 'F
' | fdisk /dev/nvme0n1 | grep 'Un' | awk -F': ' '{print $3}' | awk -F', ' '{print $1}' | awk -F' ' '{print $2}')
echo $x$y
```

###### 读取硬盘生产商

```bash
smartctl /dev/nvme0n1 -i | grep 'Model Number' | awk -F':' '{print $2}' | awk -F' ' '{print $1" "$2" "$3}'
```

###### 读取硬盘大小

```bash
lsblk -n -o kname,size -d | grep 'nvme0n1' | awk -F' ' '{print $2}'
```



### 分区系统代码重构

##### 功能设计

- 自动分区
  - 未提前分区，且未预留空间：报错退出
  - 未提前分区，已预留空间：自动识别空间大小，创建新分区，创建文件系统，挂载
  - 已提前分区：识别分区，重建文件系统，挂载
- 手动分区
  - 未提前分区，且未预留空间：报错推出
  - 未提前分区，已预留空间：选择需要安装

##### 自动逻辑设计

- 扫描所有硬盘
  - 扫描每个硬盘的EFI分区
    - 无：
      - 检查硬盘数量
        - 只有1个：服务器新装系统，创建EFI分区并重新开始程序
        - 有多个：报错退c出
    - 有：为系统盘
      - 如果有多个硬盘，只取第一个有EFI分区的硬盘
      - 检查有无Linux文件系统分区
        - 有：检查分区大小是否足够
          - 否：报错退出
          - 是：重建文件系统
        - 无：检查有无预留空间
          - 无：报错退出
          - 有：检查大小是否足够
            - 否：报错退出
            - 是：创建新分区并设为系统安装盘

##### 手动逻辑设计

- 扫描所有硬盘
  - 扫描每个硬盘的EFI分区
    - 无
      - 检查硬盘数量
        - 只有1个：服务器新装系统，提示用户创建EFI分区并重新开始程序
        - 有多个：提示用户选择系统盘
    - 有：为系统盘
      - 如果有多个硬盘，列出所有的EFI分区，提示用户选择
      - 检查有无Linux文件系统分区
        - 有：提示用户选择
        - 无：提示用户创建